{% comment %}
  通用商品网格组件
  用于展示商品列表，支持不同的布局样式

  参数说明:
  - grid_style: 网格样式 ('crazy', 'flash', 'halloween')
  - grid_class: 额外的 CSS class (可选)
  - show_reviews: 是否显示评论
  - currency_symbol: 货币符号
  - section_blocks: section.blocks 数组 (用于遍历产品块)
  - filter_category: 过滤分类编号 (用于 flash-sale 和 halloween)
  - bulk_products: 批量产品列表 (仅 flash 风格)；若同 Tab 下有 Product 块选同一产品，则使用该块的自定义图/标题/描述
{% endcomment %}

{%- liquid
  assign grid_style = grid_style | default: 'standard'
  assign bulk_products = bulk_products | default: null
-%}

<div class='product-grid product-grid--{{ grid_style }}{% if grid_class %} {{ grid_class }}{% endif %}'>
  {% comment %} Flash 风格且传入批量产品：按列表顺序渲染，每个产品若存在同 Tab 同产品的 Product 块则使用其自定义图/标题/描述 {% endcomment %}
  {% if grid_style == 'flash' and bulk_products != blank and bulk_products.size > 0 %}
    {% for product in bulk_products %}
      {%- liquid
        assign custom_image = null
        assign custom_title = null
        assign custom_description = null
        assign card_shopify_attributes = null
        if section_blocks and filter_category
          for blk in section_blocks
            if blk.type == 'product_item'
              assign pnum = blk.settings.parent_tab_number | plus: 0
              if pnum == filter_category and blk.settings.product != blank and blk.settings.product.id == product.id
                assign custom_image = blk.settings.custom_image
                assign custom_title = blk.settings.custom_title
                assign custom_description = blk.settings.custom_description
                assign card_shopify_attributes = blk.shopify_attributes
                break
              endif
            endif
          endfor
        endif
      -%}
      {% render 'product-card-flash',
        product: product,
        show_reviews: show_reviews,
        custom_image: custom_image,
        custom_title: custom_title,
        custom_description: custom_description,
        shopify_attributes: card_shopify_attributes
      %}
    {% endfor %}
  {% endif %}

  {% if section_blocks %}
    {% comment %} 使用 section.blocks 遍历（含自定义图/标题的单个产品块）；若该产品已在 bulk_products 中渲染过则跳过 {% endcomment %}
    {% for block in section_blocks %}
      {% if block.type == 'product_item' %}
        {% comment %} 如果有分类过滤，检查是否属于当前分类 {% endcomment %}
        {% if filter_category %}
          {% assign parent_num = 0 %}
          {% if grid_style == 'flash' %}
            {% assign parent_num = block.settings.parent_tab_number | plus: 0 %}
          {% elsif grid_style == 'halloween' %}
            {% assign parent_num = block.settings.parent_category_number | plus: 0 %}
          {% endif %}

          {% if parent_num == filter_category %}
            {% assign product = block.settings.product %}
            {% comment %} Flash 且存在批量列表时：若该产品已在批量列表中渲染过则跳过，避免重复 {% endcomment %}
            {% if grid_style == 'flash' and bulk_products != blank and product != blank %}
              {% assign already_in_bulk = false %}
              {% for p in bulk_products %}
                {% if p.id == product.id %}
                  {% assign already_in_bulk = true %}
                  {% break %}
                {% endif %}
              {% endfor %}
            {% else %}
              {% assign already_in_bulk = false %}
            {% endif %}

            {% if already_in_bulk == false %}
              {% if grid_style == 'flash' %}
                {% render 'product-card-flash',
                  product: product,
                  show_reviews: show_reviews,
                  custom_image: block.settings.custom_image,
                  custom_title: block.settings.custom_title,
                  custom_description: block.settings.custom_description,
                  shopify_attributes: block.shopify_attributes
                %}
              {% elsif grid_style == 'halloween' %}
                {% render 'product-card-halloween',
                  product: product,
                  show_reviews: show_reviews,
                  button_text: block.settings.button_text,
                  custom_image: block.settings.custom_image,
                  custom_title: block.settings.custom_title,
                  custom_description: block.settings.custom_description,
                  custom_compare_price: block.settings.custom_compare_price,
                  custom_discount_percent: block.settings.custom_discount_percent,
                  shopify_attributes: block.shopify_attributes
                %}
              {% endif %}
            {% endif %}
          {% endif %}

        {% else %}
          {% comment %} 没有分类过滤，直接渲染 {% endcomment %}

          {% if grid_style == 'crazy' %}
            {% comment %} Crazy Weekend Sale 使用自定义字段 {% endcomment %}
            {% render 'product-card-crazy',
              product_image: block.settings.product_image,
              product_title: block.settings.product_title,
              product_desc: block.settings.product_desc,
              product_url: block.settings.product_url,
              old_price: block.settings.old_price,
              new_price: block.settings.new_price,
              card_type: block.settings.card_type,
              badge_image: block.settings.badge_image,
              currency_symbol: currency_symbol,
              button_text: block.settings.button_text,
              shopify_attributes: block.shopify_attributes
            %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}
</div>
