{% comment %}
  通用商品网格组件
  用于展示商品列表，支持不同的布局样式

  参数说明:
  - grid_style: 网格样式 ('crazy', 'flash', 'halloween')
  - grid_class: 额外的 CSS class (可选)
  - show_reviews: 是否显示评论
  - currency_symbol: 货币符号
  - section_blocks: section.blocks 数组 (用于遍历产品块)
  - filter_category: 过滤分类编号 (用于 flash-sale 和 halloween)
  - collection: Collection 对象 (可选，用于批量添加商品)
  - collection_limit: Collection 商品数量上限 (默认 12)
  - collection_position: Collection 商品显示位置 ('before', 'after', 'only')
  - collection_dedupe: 是否去重 (默认 true)
{% endcomment %}

{%- liquid
  assign grid_style = grid_style | default: 'standard'
  assign collection_limit = collection_limit | default: 12
  assign collection_position = collection_position | default: 'after'
  if collection_dedupe == null
    assign collection_dedupe = true
  endif

  comment
    收集手动添加的商品 ID，用于去重
  endcomment
  assign manual_product_ids = ''
  if section_blocks and collection_dedupe
    for block in section_blocks
      if block.type == 'product_item' and block.settings.product != blank
        if filter_category
          assign parent_num = 0
          if grid_style == 'flash'
            assign parent_num = block.settings.parent_tab_number | plus: 0
          elsif grid_style == 'halloween'
            assign parent_num = block.settings.parent_category_number | plus: 0
          endif
          if parent_num == filter_category
            if manual_product_ids == ''
              assign manual_product_ids = block.settings.product.id | append: ''
            else
              assign manual_product_ids = manual_product_ids | append: ',' | append: block.settings.product.id
            endif
          endif
        else
          if manual_product_ids == ''
            assign manual_product_ids = block.settings.product.id | append: ''
          else
            assign manual_product_ids = manual_product_ids | append: ',' | append: block.settings.product.id
          endif
        endif
      endif
    endfor
  endif
  assign manual_product_ids_array = manual_product_ids | split: ','
-%}

<div class='product-grid product-grid--{{ grid_style }}{% if grid_class %} {{ grid_class }}{% endif %}'>
  {% comment %} === Collection 商品 (before 模式) === {% endcomment %}
  {% if collection != blank and collection_position == 'before' %}
    {%- liquid
      assign collection_count = 0
    -%}
    {% for product in collection.products limit: collection_limit %}
      {%- liquid
        assign should_skip = false
        if collection_dedupe
          assign product_id_str = product.id | append: ''
          if manual_product_ids_array contains product_id_str
            assign should_skip = true
          endif
        endif
      -%}
      {% unless should_skip %}
        {%- liquid
          assign collection_count = collection_count | plus: 1
        -%}
        {% if grid_style == 'flash' %}
          {% render 'product-card-flash', product: product, show_reviews: show_reviews %}
        {% elsif grid_style == 'halloween' %}
          {% render 'product-card-halloween', product: product, show_reviews: show_reviews %}
        {% endif %}
      {% endunless %}
    {% endfor %}
  {% endif %}

  {% comment %} === 手动添加的商品 (非 only 模式) === {% endcomment %}
  {% if section_blocks and collection_position != 'only' %}
    {% for block in section_blocks %}
      {% if block.type == 'product_item' %}
        {% comment %} 如果有分类过滤，检查是否属于当前分类 {% endcomment %}
        {% if filter_category %}
          {% assign parent_num = 0 %}
          {% if grid_style == 'flash' %}
            {% assign parent_num = block.settings.parent_tab_number | plus: 0 %}
          {% elsif grid_style == 'halloween' %}
            {% assign parent_num = block.settings.parent_category_number | plus: 0 %}
          {% endif %}

          {% if parent_num == filter_category %}
            {% assign product = block.settings.product %}

            {% if grid_style == 'flash' %}
              {% render 'product-card-flash',
                product: product,
                show_reviews: show_reviews,
                custom_image: block.settings.custom_image,
                custom_title: block.settings.custom_title,
                custom_description: block.settings.custom_description,
                shopify_attributes: block.shopify_attributes
              %}
            {% elsif grid_style == 'halloween' %}
              {% render 'product-card-halloween',
                product: product,
                show_reviews: show_reviews,
                button_text: block.settings.button_text,
                custom_image: block.settings.custom_image,
                custom_title: block.settings.custom_title,
                custom_description: block.settings.custom_description,
                custom_compare_price: block.settings.custom_compare_price,
                custom_discount_percent: block.settings.custom_discount_percent,
                shopify_attributes: block.shopify_attributes
              %}
            {% endif %}
          {% endif %}

        {% else %}
          {% comment %} 没有分类过滤，直接渲染 {% endcomment %}

          {% if grid_style == 'crazy' %}
            {% comment %} Crazy Weekend Sale 使用自定义字段 {% endcomment %}
            {% render 'product-card-crazy',
              product_image: block.settings.product_image,
              product_title: block.settings.product_title,
              product_desc: block.settings.product_desc,
              product_url: block.settings.product_url,
              old_price: block.settings.old_price,
              new_price: block.settings.new_price,
              card_type: block.settings.card_type,
              badge_image: block.settings.badge_image,
              currency_symbol: currency_symbol,
              button_text: block.settings.button_text,
              shopify_attributes: block.shopify_attributes
            %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% comment %} === Collection 商品 (after 或 only 模式) === {% endcomment %}
  {% if collection != blank and collection_position != 'before' %}
    {%- liquid
      assign collection_count = 0
    -%}
    {% for product in collection.products limit: collection_limit %}
      {%- liquid
        assign should_skip = false
        if collection_dedupe and collection_position != 'only'
          assign product_id_str = product.id | append: ''
          if manual_product_ids_array contains product_id_str
            assign should_skip = true
          endif
        endif
      -%}
      {% unless should_skip %}
        {%- liquid
          assign collection_count = collection_count | plus: 1
        -%}
        {% if grid_style == 'flash' %}
          {% render 'product-card-flash', product: product, show_reviews: show_reviews %}
        {% elsif grid_style == 'halloween' %}
          {% render 'product-card-halloween', product: product, show_reviews: show_reviews %}
        {% endif %}
      {% endunless %}
    {% endfor %}
  {% endif %}
</div>
