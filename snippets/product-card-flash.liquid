{% comment %}
  Flash Sale 商品卡片组件
  使用 Shopify 产品对象，折扣基于系统价格（compare_at_price）

  参数:
  - product: Shopify 产品对象 (必需)
  - show_reviews: 是否显示评论
  - custom_image: 自定义商品图片 (可选)
  - custom_title: 自定义标题 (可选)
  - custom_description: 自定义描述 (可选)
  - shopify_attributes: Shopify 属性
{% endcomment %}

{% if product %}
  {%- liquid
    # 获取最便宜的变体用于计算折扣
    assign cheapest_variant = product.variants | sort: 'price' | first

    # 使用系统价格
    assign compare_price = cheapest_variant.compare_at_price
    assign sale_price = cheapest_variant.price
    assign show_compare_price = false

    # 判断是否有折扣（基于系统 compare_at_price）
    if compare_price > sale_price
      assign show_compare_price = true
    endif
  -%}

  <a href='{{ product.url }}' class='product-card product-card--flash' {{ shopify_attributes }}>
    <!-- Product Image -->
    <div class='product-card__image-wrapper'>
      {%- liquid
        # 优先使用自定义图片
        assign display_image = custom_image | default: product.featured_image
        assign display_title = custom_title | default: product.title
      -%}

      {% if display_image %}
        <img
          src='{{ display_image | image_url: width: 400 }}'
          srcset='
            {{ display_image | image_url: width: 200 }} 200w,
            {{ display_image | image_url: width: 400 }} 400w,
            {{ display_image | image_url: width: 600 }} 600w
          '
          sizes='(max-width: 640px) 50vw, (max-width: 1024px) 33vw, 25vw'
          alt='{{ display_title | escape }}'
          width='400'
          height='400'
          loading='lazy'
          class='product-card__image'
        >
      {% else %}
        <div class='product-card__image product-card__image--placeholder'>
          {{ 'product-1' | placeholder_svg_tag }}
        </div>
      {% endif %}

      {% comment %} 使用主题的 product-label 组件显示折扣标签 {% endcomment %}
      {%- render 'product-label', product: product, cheapest_variant: cheapest_variant -%}

      <!-- Hot Tag -->
      {% if product.tags contains 'HOT' or product.tags contains 'hot' %}
        <div class='product-card__hot-tag'>
          <span>HOT</span>
        </div>
      {% endif %}
    </div>

    <!-- Product Info -->
    <div class='product-card__info'>
      <h3 class='product-card__title'>{{ display_title }}</h3>

      <!-- Custom Description (Optional) -->
      {% if custom_description != blank %}
        <p class='product-card__description'>{{ custom_description }}</p>
      {% endif %}

      <!-- Price (使用系统价格) -->
      <div class='product-card__price'>
        {% if show_compare_price %}
          {% comment %} 显示原价和折扣价（符合 Shopify 官方格式） {% endcomment %}
          <s class='product-card__price-compare'>{{ compare_price | money }}</s>
          <span class='product-card__price-sale'>{{ sale_price | money }}</span>
        {% else %}
          {% comment %} 只显示当前价格 {% endcomment %}
          <span class='product-card__price-sale'>{{ sale_price | money }}</span>
        {% endif %}
      </div>

      <!-- Reviews (Optional) -->
      {% if show_reviews and product.metafields.reviews.rating_count.value %}
        <div class='product-card__reviews'>
          {{ product.metafields.reviews.rating_count.value }} Review(s)
        </div>
      {% endif %}
    </div>
  </a>

  <!-- 商品结构化数据 -->
  {% render 'product-structured-data',
    product: product,
    custom_title: custom_title,
    custom_description: custom_description,
    custom_image: custom_image
  %}
{% endif %}
