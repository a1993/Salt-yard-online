{% comment %}
  Halloween Sale 商品网格组件
  专门用于展示 Halloween Sale 商品列表
  
  参数说明:
  - grid_class: 额外的 CSS class (可选)
  - show_reviews: 是否显示评论
  - section_blocks: section.blocks 数组 (用于遍历产品块)
  - filter_category: 过滤分类编号 (可选，用于过滤特定分类的商品)
  - category_discount_percent: 分类折扣百分比 (可选)
{% endcomment %}

<div class="product-grid product-grid--halloween{% if grid_class %} {{ grid_class }}{% endif %}">
  {% if section_blocks %}
    {% comment %} 使用 section.blocks 遍历 {% endcomment %}
    {% for block in section_blocks %}
      {% if block.type == 'product_item' %}
        
        {% comment %} 如果有分类过滤，检查是否属于当前分类 {% endcomment %}
        {% if filter_category %}
          {% assign parent_num = block.settings.parent_category_number | plus: 0 %}
          
          {% if parent_num == filter_category %}
            {% assign product = block.settings.product %}
            
            {% render 'product-card-halloween',
              product: product,
              show_reviews: show_reviews,
              button_text: block.settings.button_text,
              custom_image: block.settings.custom_image,
              custom_title: block.settings.custom_title,
              custom_description: block.settings.custom_description,
              custom_compare_price: block.settings.custom_compare_price,
              custom_discount_percent: block.settings.custom_discount_percent,
              category_discount_percent: category_discount_percent,
              shopify_attributes: block.shopify_attributes
            %}
          {% endif %}
          
        {% else %}
          {% comment %} 没有分类过滤，直接渲染所有产品 {% endcomment %}
          {% assign product = block.settings.product %}
          
          {% render 'product-card-halloween',
            product: product,
            show_reviews: show_reviews,
            button_text: block.settings.button_text,
            custom_image: block.settings.custom_image,
            custom_title: block.settings.custom_title,
            custom_description: block.settings.custom_description,
            custom_compare_price: block.settings.custom_compare_price,
            custom_discount_percent: block.settings.custom_discount_percent,
            category_discount_percent: category_discount_percent,
            shopify_attributes: block.shopify_attributes
          %}
        {% endif %}
      {% elsif block.type == 'product_collection' %}
        {% comment %} 处理产品系列 {% endcomment %}
        {% assign collection = block.settings.collection %}
        {% if collection %}
          {% comment %} 检查分类过滤 {% endcomment %}
          {% assign should_render = false %}
          {% if filter_category %}
            {% assign parent_num = block.settings.parent_category_number | plus: 0 %}
            {% if parent_num == filter_category %}
              {% assign should_render = true %}
            {% endif %}
          {% else %}
            {% assign should_render = true %}
          {% endif %}

          {% if should_render %}
            {% comment %} 获取产品限制数量 {% endcomment %}
            {% assign product_limit = block.settings.product_limit | plus: 0 %}
            {% if product_limit == 0 %}
              {% assign product_limit = 999 %}
            {% endif %}

            {% comment %} 遍历 collection 中的产品 {% endcomment %}
            {% for product in collection.products limit: product_limit %}
              {% render 'product-card-halloween',
                product: product,
                show_reviews: show_reviews,
                button_text: null,
                custom_image: null,
                custom_title: null,
                custom_description: null,
                custom_compare_price: null,
                custom_discount_percent: block.settings.custom_discount_percent,
                category_discount_percent: category_discount_percent,
                shopify_attributes: block.shopify_attributes
              %}
            {% endfor %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}
</div>

