{% comment %}
  Product Grid Flash Section
  使用与 flash-sale 相同的样式，确保卡片样式一致
{% endcomment %}

{{ 'product-card.css' | asset_url | stylesheet_tag }}
{{ 'flash-sale.css' | asset_url | stylesheet_tag }}

{%- liquid
  # 支持作为 section 使用（从 section.settings 获取）或作为 snippet 使用（从参数获取）
  assign show_reviews = show_reviews | default: section.settings.show_reviews | default: false
  assign section_blocks = section_blocks | default: section.blocks
  assign filter_category = filter_category | default: section.settings.filter_category | default: 0
  assign grid_class = grid_class | default: ''
  assign products_per_row = products_per_row | default: section.settings.products_per_row | default: 4
  assign products_per_row_mobile = products_per_row_mobile | default: section.settings.products_per_row_mobile | default: settings.prod_thumb_mob_per_row | default: 2
  assign bulk_products = bulk_products | default: section.settings.product_list | default: null
-%}

<div class='product-grid product-grid--flash product-grid--per-row-{{ products_per_row }} product-grid--per-row-mob-{{ products_per_row_mobile }}{% if grid_class %} {{ grid_class }}{% endif %}'>
  {%- liquid
    assign has_products = false
    assign product_count = 0
    if bulk_products != blank and bulk_products.size > 0
      assign has_products = true
    endif
    unless has_products
      if section_blocks
        for block in section_blocks
          if block.type == 'product_item'
            if filter_category and filter_category > 0
              assign parent_num = block.settings.parent_tab_number | plus: 0
              if parent_num == filter_category and block.settings.product != blank
                assign has_products = true
                assign product_count = product_count | plus: 1
              endif
            else
              if block.settings.product != blank
                assign has_products = true
                assign product_count = product_count | plus: 1
              endif
            endif
          endif
        endfor
      endif
    endunless
  -%}

  {% if has_products %}
    {% comment %} 先渲染批量产品；若存在同产品的 Product 块则使用其自定义图/标题/描述 {% endcomment %}
    {% if bulk_products != blank and bulk_products.size > 0 %}
      {% for product in bulk_products %}
        {%- liquid
          assign custom_image = null
          assign custom_title = null
          assign custom_description = null
          assign card_shopify_attributes = null
          if section_blocks
            for blk in section_blocks
              if blk.type == 'product_item' and blk.settings.product != blank and blk.settings.product.id == product.id
                if filter_category != 0
                  assign pnum = blk.settings.parent_tab_number | plus: 0
                  if pnum == filter_category
                    assign custom_image = blk.settings.custom_image
                    assign custom_title = blk.settings.custom_title
                    assign custom_description = blk.settings.custom_description
                    assign card_shopify_attributes = blk.shopify_attributes
                    break
                  endif
                else
                  assign custom_image = blk.settings.custom_image
                  assign custom_title = blk.settings.custom_title
                  assign custom_description = blk.settings.custom_description
                  assign card_shopify_attributes = blk.shopify_attributes
                  break
                endif
              endif
            endfor
          endif
        -%}
        {% render 'product-card-flash',
          product: product,
          show_reviews: show_reviews,
          custom_image: custom_image,
          custom_title: custom_title,
          custom_description: custom_description,
          shopify_attributes: card_shopify_attributes
        %}
      {% endfor %}
    {% endif %}
    {% comment %} 再渲染未在批量列表中的 Product 块，避免重复 {% endcomment %}
    {% for block in section_blocks %}
      {% if block.type == 'product_item' %}
        {% if filter_category and filter_category > 0 %}
          {% assign parent_num = block.settings.parent_tab_number | plus: 0 %}
          {% if parent_num == filter_category %}
            {% assign product = block.settings.product %}
            {% if product %}
              {% assign already_in_bulk = false %}
              {% if bulk_products != blank %}
                {% for p in bulk_products %}
                  {% if p.id == product.id -%}
                    {%- assign already_in_bulk = true -%}
                    {%- break -%}
                  {%- endif %}
                {% endfor %}
              {% endif %}
              {% unless already_in_bulk %}
                {% render 'product-card-flash',
                  product: product,
                  show_reviews: show_reviews,
                  custom_image: block.settings.custom_image,
                  custom_title: block.settings.custom_title,
                  custom_description: block.settings.custom_description,
                  shopify_attributes: block.shopify_attributes
                %}
              {% endunless %}
            {% endif %}
          {% endif %}
        {% else %}
          {% assign product = block.settings.product %}
          {% if product %}
            {% assign already_in_bulk = false %}
            {% if bulk_products != blank %}
              {% for p in bulk_products %}
                {% if p.id == product.id -%}
                  {%- assign already_in_bulk = true -%}
                  {%- break -%}
                {%- endif %}
              {% endfor %}
            {% endif %}
            {% unless already_in_bulk %}
              {% render 'product-card-flash',
                product: product,
                show_reviews: show_reviews,
                custom_image: block.settings.custom_image,
                custom_title: block.settings.custom_title,
                custom_description: block.settings.custom_description,
                shopify_attributes: block.shopify_attributes
              %}
            {% endunless %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% else %}
    {% comment %} 预览模式：显示占位产品卡片（仅系统折扣） {% endcomment %}
    {%- assign placeholder_compare = 299 -%}
    {% for i in (1..4) %}
      <div class='product-card product-card--flash product-card--placeholder'>
        <div class='product-card__image-wrapper'>
          <div class='product-card__image product-card__image--placeholder'>
            {{ 'product-1' | placeholder_svg_tag }}
          </div>
        </div>
        <div class='product-card__info'>
          <h3 class='product-card__title'>示例产品 {{ i }}</h3>
          <p class='product-card__description'>请选择一个产品以显示实际内容</p>
          <div class='product-card__price'>
            <span class='product-card__price-sale'>${{ placeholder_compare }}.00</span>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>

{% schema %}
{
  "name": "Product Grid Flash",
  "settings": [
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "products_per_row",
      "label": "Products per row (Desktop)",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "info": "Number of products to display per row on desktop"
    },
    {
      "type": "range",
      "id": "products_per_row_mobile",
      "label": "Products per row (Mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2,
      "info": "Number of products to display per row on mobile"
    },
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "product_list",
      "id": "product_list",
      "label": "批量产品（可选）",
      "info": "一次添加多个产品。若需自定义某款的图片/标题/描述，请添加「Product」块并选择同一产品即可覆盖该卡片"
    },
    {
      "type": "checkbox",
      "id": "show_reviews",
      "label": "Show Reviews",
      "default": false
    },
    {
      "type": "number",
      "id": "filter_category",
      "label": "Filter Category",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "product_item",
      "name": "Product Item",
      "settings": [
        {
          "type": "number",
          "id": "parent_tab_number",
          "label": "Parent Tab Number",
          "default": 1
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "image_picker",
          "id": "custom_image",
          "label": "Custom Image",
          "info": "Leave blank to use product's featured image"
        },
        {
          "type": "text",
          "id": "custom_title",
          "label": "Custom Title",
          "info": "Leave blank to use product's title"
        },
        {
          "type": "textarea",
          "id": "custom_description",
          "label": "Custom Description",
          "info": "Leave blank to use product's description"
        },
        {
          "type": "text",
          "id": "custom_class",
          "label": "Custom Class",
          "info": "Leave blank to use product's custom class"
        },
        {
          "type": "text",
          "id": "shopify_attributes",
          "label": "Shopify Attributes",
          "info": "Leave blank to use product's shopify attributes"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "[gy] Product Grid Flash",
      "blocks": [
        {
          "type": "product_item",
          "settings": {
            "parent_tab_number": 1
          }
        },
        {
          "type": "product_item",
          "settings": {
            "parent_tab_number": 1
          }
        },
        {
          "type": "product_item",
          "settings": {
            "parent_tab_number": 1
          }
        },
        {
          "type": "product_item",
          "settings": {
            "parent_tab_number": 1
          }
        },
        {
          "type": "product_item",
          "settings": {
            "parent_tab_number": 1
          }
        },
        {
          "type": "product_item",
          "settings": {
            "parent_tab_number": 1
          }
        }
      ]
    }
  ]
}
{% endschema %}

{% style %}
  /* Placeholder Product Cards */
  .product-card--placeholder {
    opacity: 0.8;
    pointer-events: none;
  }

  .product-card--placeholder .product-card__image--placeholder {
    background-color: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
  }

  .product-card--placeholder .product-card__title {
    margin: 0.5rem 0;
    font-size: 1rem;
    font-weight: 500;
  }

  .product-card--placeholder .product-card__description {
    font-size: 0.875rem;
    color: #999;
    margin: 0.5rem 0;
  }
{% endstyle %}
