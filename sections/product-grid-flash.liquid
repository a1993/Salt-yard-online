{% comment %}
  Product Grid Flash Section
  使用与 flash-sale 相同的样式，确保卡片样式一致
{% endcomment %}

{{ 'product-card.css' | asset_url | stylesheet_tag }}
{{ 'flash-sale.css' | asset_url | stylesheet_tag }}

{%- liquid
  # 支持作为 section 使用（从 section.settings 获取）或作为 snippet 使用（从参数获取）
  assign show_reviews = show_reviews | default: section.settings.show_reviews | default: false
  assign discount_percent = discount_percent | default: section.settings.discount_percent | default: 0
  assign section_blocks = section_blocks | default: section.blocks
  assign filter_category = filter_category | default: section.settings.filter_category | default: 0
  assign grid_class = grid_class | default: ''
  assign products_per_row = products_per_row | default: section.settings.products_per_row | default: 4
  assign products_per_row_mobile = products_per_row_mobile | default: section.settings.products_per_row_mobile | default: settings.prod_thumb_mob_per_row | default: 2
-%}

<div class='product-grid product-grid--flash product-grid--per-row-{{ products_per_row }} product-grid--per-row-mob-{{ products_per_row_mobile }}{% if grid_class %} {{ grid_class }}{% endif %}'>
  {% if section_blocks %}
    {% for block in section_blocks %}
      {% if block.type == 'product_item' %}
        {% if filter_category and filter_category > 0 %}
          {% comment %} 如果有分类过滤，检查是否属于当前分类 {% endcomment %}
          {% assign parent_num = block.settings.parent_tab_number | plus: 0 %}
          {% if parent_num == filter_category %}
            {% assign product = block.settings.product %}
            {% render 'product-card-flash',
              product: product,
              show_reviews: show_reviews,
              discount_percent: discount_percent,
              custom_image: block.settings.custom_image,
              custom_title: block.settings.custom_title,
              custom_description: block.settings.custom_description,
              custom_compare_price: block.settings.custom_compare_price,
              custom_discount_percent: block.settings.custom_discount_percent,
              shopify_attributes: block.shopify_attributes
            %}
          {% endif %}
        {% else %}
          {% comment %} 没有分类过滤，直接渲染所有产品 {% endcomment %}
          {% assign product = block.settings.product %}
          {% render 'product-card-flash',
            product: product,
            show_reviews: show_reviews,
            discount_percent: discount_percent,
            custom_image: block.settings.custom_image,
            custom_title: block.settings.custom_title,
            custom_description: block.settings.custom_description,
            custom_compare_price: block.settings.custom_compare_price,
            custom_discount_percent: block.settings.custom_discount_percent,
            shopify_attributes: block.shopify_attributes
          %}
        {% endif %}
      {% elsif block.type == 'product_collection' %}
        {% comment %} 处理产品系列 {% endcomment %}
        {% assign collection = block.settings.collection %}
        {% if collection %}
          {% comment %} 检查分类过滤 {% endcomment %}
          {% assign should_render = false %}
          {% if filter_category and filter_category > 0 %}
            {% assign parent_num = block.settings.parent_tab_number | plus: 0 %}
            {% if parent_num == filter_category %}
              {% assign should_render = true %}
            {% endif %}
          {% else %}
            {% assign should_render = true %}
          {% endif %}

          {% if should_render %}
            {% comment %} 获取产品限制数量 {% endcomment %}
            {% assign product_limit = block.settings.product_limit | plus: 0 %}
            {% if product_limit == 0 %}
              {% assign product_limit = 999 %}
            {% endif %}

            {% comment %} 遍历 collection 中的产品 {% endcomment %}
            {% for product in collection.products limit: product_limit %}
              {% render 'product-card-flash',
                product: product,
                show_reviews: show_reviews,
                discount_percent: discount_percent,
                custom_image: null,
                custom_title: null,
                custom_description: null,
                custom_compare_price: null,
                custom_discount_percent: block.settings.custom_discount_percent,
                shopify_attributes: block.shopify_attributes
              %}
            {% endfor %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}
</div>

{% schema %}
{
  "name": "Product Grid Flash",
  "settings": [
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "products_per_row",
      "label": "Products per row (Desktop)",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "info": "Number of products to display per row on desktop"
    },
    {
      "type": "range",
      "id": "products_per_row_mobile",
      "label": "Products per row (Mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2,
      "info": "Number of products to display per row on mobile"
    },
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "checkbox",
      "id": "show_reviews",
      "label": "Show Reviews",
      "default": false
    },
    {
      "type": "number",
      "id": "discount_percent",
      "label": "Discount Percent",
      "default": 0
    },
    {
      "type": "number",
      "id": "filter_category",
      "label": "Filter Category",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "product_item",
      "name": "Product Item",
      "settings": [
        {
          "type": "number",
          "id": "parent_tab_number",
          "label": "Parent Tab Number",
          "default": 1
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "image_picker",
          "id": "custom_image",
          "label": "Custom Image",
          "info": "Leave blank to use product's featured image"
        },
        {
          "type": "text",
          "id": "custom_title",
          "label": "Custom Title",
          "info": "Leave blank to use product's title"
        },
        {
          "type": "textarea",
          "id": "custom_description",
          "label": "Custom Description",
          "info": "Leave blank to use product's description"
        },
        {
          "type": "text",
          "id": "custom_compare_price",
          "label": "Custom Compare Price",
          "info": "Leave blank to use product's compare_at_price"
        },
        {
          "type": "number",
          "id": "custom_discount_percent",
          "label": "Custom Discount Percent",
          "default": 0,
          "info": "Leave blank to use product's discount_percent"
        },
        {
          "type": "text",
          "id": "custom_class",
          "label": "Custom Class",
          "info": "Leave blank to use product's custom class"
        },
        {
          "type": "text",
          "id": "shopify_attributes",
          "label": "Shopify Attributes",
          "info": "Leave blank to use product's shopify attributes"
        }
      ]
    },
    {
      "type": "product_collection",
      "name": "Product Collection",
      "settings": [
        {
          "type": "number",
          "id": "parent_tab_number",
          "label": "Parent Tab Number",
          "default": 1,
          "info": "Enter 1 for first tab, 2 for second tab, etc."
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Select Collection",
          "info": "All products from this collection will be displayed"
        },
        {
          "type": "number",
          "id": "product_limit",
          "label": "Product Limit",
          "default": 50,
          "info": "Maximum number of products to display from collection (0 = no limit)"
        },
        {
          "type": "number",
          "id": "custom_discount_percent",
          "label": "Custom Discount %",
          "default": 0,
          "info": "Override section discount. Set to 0 to use section discount or product's system discount. Example: 20 for 20% OFF"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Grid Flash"
    }
  ]
}
{% endschema %}
